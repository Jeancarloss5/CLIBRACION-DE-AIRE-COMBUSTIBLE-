#include <SPI.h>
#include <mcp_can.h>
#include <Wire.h>
#include <Adafruit_BMP085.h>
#include <math.h>

#define CAN_CS 10
#define CAN_INT 2
#define TERMISTOR A0

// ===== Parámetros NTC =====
#define R_REF 10000.0
#define BETA 3950.0
#define T0 298.15

MCP_CAN CAN(CAN_CS);
Adafruit_BMP085 bmp;

void setup() {
  Serial.begin(9600);

  // ===== Inicializar CAN =====
  while (CAN.begin(MCP_ANY, CAN_500KBPS, MCP_16MHZ) != CAN_OK) {
    Serial.println("Error CAN...");
    delay(500);
  }

  CAN.setMode(MCP_NORMAL);
  pinMode(CAN_INT, INPUT);

  // ===== Inicializar BMP180 =====
  if (!bmp.begin()) {
    Serial.println("BMP180 NO detectado");
    while (1);
  }

  Serial.println("EMISOR CAN LISTO");
}

void loop() {

  // ===== TERMISTOR =====
  int adc = analogRead(TERMISTOR);
  float v = adc * (5.0 / 1023.0);

  float r_ntc = R_REF * (5.0 / v - 1.0);

  float tempNTC = (1.0 / (log(r_ntc / R_REF) / BETA + 1.0 / T0)) - 273.15;

  // ===== BMP180 =====
  float tempBMP = bmp.readTemperature();
  int32_t presionPa = bmp.readPressure();   // Pascales

  // ===== TRAMA CAN =====
  byte data[8];

  data[0] = (int8_t)tempNTC;   // Temperatura NTC (°C)
  data[1] = (int8_t)tempBMP;   // Temperatura BMP (°C)

  // Presión en int32 (Pa)
  data[2] = (presionPa >> 24) & 0xFF;
  data[3] = (presionPa >> 16) & 0xFF;
  data[4] = (presionPa >> 8)  & 0xFF;
  data[5] = presionPa & 0xFF;

  data[6] = 0;
  data[7] = 0;

  CAN.sendMsgBuf(0x100, 0, 8, data);

  // ===== Debug Serial =====
  Serial.print("NTC: ");
  Serial.print(tempNTC);

  Serial.print("  BMP: ");
  Serial.print(tempBMP);

  Serial.print("  Presion: ");
  Serial.print(presionPa / 100.0);
  Serial.println(" hPa");

  delay(500);
}
-------------------------------------------
#include <SPI.h>
#include <mcp_can.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define CAN_CS 10
#define CAN_INT 2

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

// Constructor seguro para la mayoría de pantallas
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);
MCP_CAN CAN(CAN_CS);

float tempNTC = 0;
float tempBMP = 0;
float presion = 0;

void setup() {
  Serial.begin(9600);

  // Inicializar CAN
  while (CAN.begin(MCP_ANY, CAN_500KBPS, MCP_8MHZ) != CAN_OK) {
    Serial.println("Error CAN...");
    delay(500);
  }
  CAN.setMode(MCP_NORMAL);
  pinMode(CAN_INT, INPUT);

  // Inicializar OLED
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    Serial.println("OLED Fallo");
    while(1);
  }

  display.clearDisplay();
  display.display();
}

void loop() {
  if (CAN.checkReceive() == CAN_MSGAVAIL) {

    long unsigned int rxId;
    byte len = 0;
    byte buf[8];

    CAN.readMsgBuf(&rxId, &len, buf);

    if (rxId == 0x100) {

      tempNTC = (int8_t)buf[0];
      tempBMP = (int8_t)buf[1];

      int32_t presionPa = ((int32_t)buf[2] << 24) |
                          ((int32_t)buf[3] << 16) |
                          ((int32_t)buf[4] << 8)  |
                           (int32_t)buf[5];

      presion = presionPa / 100.0;

      Serial.print("NTC: "); Serial.print(tempNTC);
      Serial.print(" BMP: "); Serial.print(tempBMP);
      Serial.print(" Presion: "); Serial.println(presion);

      drawDisplay();
    }
  }
}

// Termómetro pequeño
void drawSmallThermometer(int x, int y, float temperature) {
  int height = 20;
  int width = 8;

  display.drawRect(x, y, width, height, WHITE);
  display.drawCircle(x + width/2, y + height + 3, 3, WHITE);

  int level = map(temperature, 0, 50, 0, height);
  level = constrain(level, 0, height);

  display.fillRect(x + 2, y + height - level, width - 4, level, WHITE);
  display.fillCircle(x + width/2, y + height + 3, 2, WHITE);
}

// Pantalla completa
void drawDisplay() {
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.setTextSize(1); // tamaño seguro

  // NTC
  drawSmallThermometer(5, 5, tempNTC);
  display.setCursor(20, 5);  display.print("NTC");
  display.setCursor(20, 15); display.print(tempNTC, 1); display.print(" C");

  // BMP
  drawSmallThermometer(5, 35, tempBMP);
  display.setCursor(20, 35); display.print("BMP180");
  display.setCursor(20, 45); display.print(tempBMP, 1); display.print(" C");

  // Línea divisoria
  display.drawLine(65, 0, 65, 64, WHITE);

  // Presión
  display.setCursor(75, 25); display.print("Presion");
  display.setCursor(75, 35); display.print(presion, 1); display.print(" hPa");

  display.display();
}
